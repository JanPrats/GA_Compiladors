                  ┌───────────────────────┐
                  │ Inici parse_until()   │
                  └─────────┬─────────────┘
                            │
                            ▼
                  ┌───────────────────────┐
                  │ Llegir caràcter c     │
                  │ read_char()           │
                  └─────────┬─────────────┘
                            │
                            ▼
             ┌─────────Si c == '\0'?─────────┐
             │                               │
           Sí ▼                              No ▼
      ┌────────────┐                   ┌─────────────────┐
      │ Retorna 0  │                   │Estem al principi │
      └────────────┘                   │ de línia?        │
                                       |at_line_start=true| 
                                       └─────────┬────────┘
                                                  │
                                                  ▼
                                ┌─────────Si c == '#' i directives habilitades?────┐
                                │                                                     │
                               Sí ▼                                                   No ▼
            ┌────────────────────────────┐                      ┌─────────────────────────────┐
            │ Salta espais               │                      │ c == '/' ?                  │
            │ Llegeix directiva          │                      │                             │
            └─────────────┬───────────────┘                      └─────────────┬─────────────┘
                          │                                                  │
                          ▼                                                  ▼
         ┌─────────Compara directiva─────────┐                       ┌───── Comentari? ─────┐
         │ include / define / ifdef / ...    │                       │ Sí─process_comment() │
         └─────────────┬────────────────────┘                        │ No ─ continua        │
                       │                                                 │
                       ▼                                                 ▼
          ┌─────────Directiva #include?────────┐             ┌────────c == '"' ?────────┐
          │ Sí → process_include()             │             │ Sí → Copiar si           │
          │ No → #define?                      │             │      copy_to_output      │
          │ Sí → process_define()              │             └─────────┬─────────────────┘
          │ No → #ifdef / #ifndef?             │                       │
          │ Sí → process_ifdef()               │                       ▼
          │ No → #else / #endif / stop_symbol?│             ┌────────Identificador?──────┐
          │ Sí → retorna 0 o error            │             │ Sí → llegir paraula        │
          └───────────────────────────────────┘             │ Substitueix macro si existeix │
                                                            |    substitute_macro()      │
                                                            └─────────┬──────────────────┘
                                                                      ▼
                                                        ┌─────────Altres caràcters────────┐
                                                        │ Copia a sortida si cal          │
                                                        │ Actualitza at_line_start        │
                                                        └─────────┬──────────────────────┘
                                                                  │
                                                                  ▼
                                                         ┌───────────────┐
                                                         │Tornar al bucle │
                                                         └────────────────┘
